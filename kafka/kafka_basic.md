### Kafka Basic

> 메세지큐에 대해 공부해 본적이 있다. 그런데 카프카는 제대로 알지 못하고 사용해본 것 같다. 간단하게라도, 카프카의 기본적인 개요 및 원리에 대해 학습해보자



### 카프카 간단 사용 구조

간단하게 카프카는 3개의 모듈을 통해 이용 가능하다. 메세지를 발행하는 Producer Server, 메세지를 가지고 있는 Kafka, 그리고 발행된 메세지를 사용하는 Consumer가 존재한다. 카프카에서 메세지는 토픽`topic`이라고 부른다.

결론적으로 카프카는 메세지큐와 같이 큐 형태의 서비스이고, 데이터를 안전하게 발행, 소비할 수 있도록 하고 고가용성을 높일 수 있는 서비스이다.



### 토픽이란?

카프카에는 다양한 데이터가 들어갈 수 있는데, 해당 데이터가 들어가는 공간을 토픽이라고 한다. 토픽은 여러개의 파티션으로 나뉘어질 수 있다. 특정 파티션에 들어간 데이터는 큐의 형태로 쌓이며, 해당 데이터를 Consumer가 소비한다.

Consumer가 데이터를 소비한다고 하더라고, 해당 데이터는 토픽에서 삭제되지 않는다! 더불어 파티션에는 고유한 키값을 지정할 수 있다.



Producer는  아래의 2가지 방법으로 나누어진 파티션에 데이터를 삽입할 수 있다.



** 키가 null이고 기본 파티션 사용 **

- 라운드 로빈으로 파티션에 데이터 할당



** 키가 존재하고, 기본 파티션을 사용 ** 

- 키의 해시를 구하여, 해시에 맞추어 파티션 할당



**파트션을 늘리는 것은 가능하지만, 줄이는 것은 불가능하다..**

> 데이터 손실이 발생할 수 있기 때문이다.



**파티션에 들어간 데이터는 특정 옵션에 따라서 삭제된다.**

- 데이터의 최대 보존시간 혹은 최대 저장공간 등을 설정하여, 데이터를 삭제할 수 있다.



### Kafka Broker

카프카가 설치되어 있는 서버의 단위를 의미, 보통 3개 이상의 서버를 구축하는 것을 권장한다.



### Kafka Replication

레플리케이션은 복제를 의미한다. 카프카의 레플리카는 데이터를 안전하게 보관하고, 고가용성으로 서버 운영에 안정성을 확보하기 위한 수단이다. 카프카의 레플리카



카프카의 브로커의 수에 따라 레플리케이션에 제한이 있다. 카프카의 레플리케이션 및 데이터 구조 예시는 다음과 같다.



**카프카 브로커 2**

- 원본1 + 복제1



**카프카 브로커 3**

- 원본1 + 복제2



> Replication3 mean --> Origin1 + Replica2



원본 파티션을 **Leader**락고 칭하며, 복제본은 **Follower**라고 한다.

Leader와 Follower를 합쳐서 **ISR(In Sync Replica)**이라고 한다.



### 파티셔너

파티셔너는 데이터를 어떤 파티션에 적재할지 정하는 역할을 한다. Producer는 데이터를 전송할 때 항상 파티셔너를 거쳐서, 데이터를 적재한다.



파티셔너는 기본적으로 아래의 두가지 방법에 따라 데이터를 파티션에 적재한다.

- 키가 있는 경우
  - 키가 존재하는 경우, 해당 키를 해시처리하여 파티션에 데이터를 적재
- 키가 없는 경우
  - 키가 없는 경우, 라운드 로빈을 통해 파티션에 데이터를 적재



추가적으로 커스텀하게 파티셔너를 가공하여 사용할 수 있다.

> 우선순위큐와 흡사



### Kafka Lag

Producer와 Concumer의 Status를 확인할 떄 사용한다. Lag은 Producer가 마지막으로 넣은 Offset과 Consumer가 마지막으로 읽은 Offset의 차이이다. Offeset은 파티션에 저장된 Record의 순번을 의미한다.

Producer가 파트션에 얼마나 많은 토픽을 생성했는지, Consumer는 해당 토픽을 얼마나 가져갔는지 등에 대한 정보를 확인할 수 있다. 그렇기 때문에 각 파티션별로 Lag이 존재한다. 



Kafka Burrow와 같은 클라이언트 라이브러리를 통해서 카프카의 상태를 확인할 수 있다. 해당 라이브러리가 대표적 (링크드인이 만들었음....)



### 메시징 플랫폼이란?

메세지를 주고 받는 미들웨어 서비스를 메시징 플랫폼이라고 한다. 메시징 플랫폼은 크게 메세지 브로커, 이벤트 브로커가 존재한다.



### 메세지 브로커

- 메세지를 받아서 처리하고, 해당 데이터를 삭제함
- 데이터를 보내고, 처리하고, 삭제 과정으로 진행
- 레빗, 레디스큐 등



### 이벤트 브로커

- 이벤트 또는 메세지를 데이터를 인덱스로 저장하고 보관하고 관리할 수 있음

- 메세지 브로커 역할을 할 수 있다.
- 이벤트 브로커는 메세지 브로커와 달리 이벤트를 바로 삭제하지 않고, 내부 큐에서 관리하여 사용할 수 있음
- 카프카, 키네시스 등







